<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #007bff; --light-primary: #e6f2ff; --secondary-color: #6c757d;
      --background-color: #f4f7f6; --card-background: #ffffff; --text-color: #333;
      --border-color: #dee2e6; --success-color: #28a745; --error-color: #dc3545;
      --shadow: 0 4px 8px rgba(0, 0, 0, 0.1); --border-radius: 12px;
    }
    body { margin: 0; padding: 16px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: var(--primary-color); text-align: center; margin-bottom: 2rem; }
    h2 { color: var(--primary-color); text-align: center; margin-bottom: 2rem; border-bottom: 2px solid var(--light-primary); padding-bottom: 1rem; }
    
    /* --- Estilos do Menu --- */
    .main-menu { display: flex; flex-direction: column; gap: 1rem; max-width: 500px; margin: 2rem auto; }
    .menu-button {
        padding: 18px 24px; font-size: 1.1rem; font-weight: 500; color: white;
        background-color: var(--primary-color); border: none; border-radius: var(--border-radius);
        cursor: pointer; transition: background-color 0.2s, transform 0.2s; text-align: left;
    }
    .menu-button:hover { background-color: #0056b3; transform: translateY(-2px); }
    
    /* --- Se√ß√µes do App --- */
    .app-section { display: none; /* Escondido por padr√£o */ }
    
    .back-button {
        background-color: transparent; border: 1px solid var(--secondary-color); color: var(--secondary-color);
        padding: 8px 16px; font-size: 0.9rem; border-radius: var(--border-radius); cursor: pointer;
        margin-bottom: 2rem;
    }
    .back-button:hover { background-color: var(--secondary-color); color: white; }

    fieldset { border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 16px; margin-bottom: 24px; background-color: var(--card-background); box-shadow: var(--shadow); }
    legend { padding: 0 8px; font-weight: 600; font-size: 1.2rem; color: var(--primary-color); }
    .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 16px; }
    .form-group { flex: 1 1 100%; }
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 1rem; }
    input, select, textarea { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--light-primary); }
    .action-button { width: 100%; padding: 16px; font-size: 1.2rem; font-weight: 600; background-color: var(--success-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s; }
    .action-button:disabled { background-color: var(--secondary-color); cursor: not-allowed; }
    #mensagem { padding: 16px; margin-top: 20px; border-radius: var(--border-radius); text-align: center; font-weight: 500; display: none; border: 1px solid transparent; }
    .message-box.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    .message-box.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    .atendido-section { display: none; }
    @media (min-width: 600px) {
        body { padding: 24px; }
        .form-group.half { flex: 1 1 calc(50% - 10px); }
        .form-group.third { flex: 1 1 calc(33.333% - 14px); }
    }
    /* --- CSS for Responsive Tables --- */
    @media screen and (max-width: 600px) {
      .responsive-table {
        border: 0;
      }

      .responsive-table thead {
        /* Hide the original table headers on mobile */
        border: none;
        clip: rect(0 0 0 0);
        height: 1px;
        margin: -1px;
        overflow: hidden;
        padding: 0;
        position: absolute;
        width: 1px;
      }
      
      .responsive-table tr {
        /* Make each row look like a card */
        display: block;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .responsive-table td {
        /* Stack cells vertically */
        display: block;
        text-align: right; /* Align cell content to the right */
        border: none;
        border-bottom: 1px solid #eee;
        padding-left: 50%; /* Make space for the label */
        position: relative;
      }
      
      .responsive-table td::before {
        /* Create the label using the data-label attribute */
        content: attr(data-label);
        position: absolute;
        left: 8px; /* Position label on the left */
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: bold;
      }
      
      .responsive-table td:last-child {
        border-bottom: 0;
      }

      /* Make form elements full-width for a better mobile experience */
      .responsive-table td select,
      .responsive-table td input,
      .responsive-table td button {
          width: 100%;
          box-sizing: border-box; /* Ensures padding doesn't mess up the width */
      }
    }
        /* --- Estilos do Dashboard --- */
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
      margin-bottom: 2.5rem;
    }
    .stat-card {
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex: 1 1 250px; /* Flex properties for responsive sizing */
    }
    .stat-icon {
      font-size: 2.5rem;
      background-color: var(--light-primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stat-title {
      color: var(--secondary-color);
      font-size: 1rem;
    }
    .stat-number {
      color: var(--primary-color);
      font-size: 2rem;
      font-weight: 700;
    }

    /* --- CSS for Atendido List --- */
    .list-container {
      margin-top: 2.5rem;
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
    }
    .list-container h3 {
      color: var(--primary-color);
      margin-top: 0;
      border-bottom: 2px solid var(--light-primary);
      padding-bottom: 1rem;
    }
    .attendance-table {
      width: 100%;
      border-collapse: collapse;
    }
    .attendance-table th,
    .attendance-table td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }
    .attendance-table th {
      font-weight: 600;
    }
    .attendance-table td:last-child {
      text-align: right;
      font-weight: 600;
      color: var(--primary-color);
    }
  </style>
</head>
<h1>Sistema da ONG</h1>
<body>
  <div id="mainMenu" class="main-menu">
  <button class="menu-button" onclick="showSection('beneficiarioSection')">üîé Buscar Atendidos</button>
  <button class="menu-button" onclick="showSection('voluntarioSearchSection')">üßë‚Äçü§ù‚Äçüßë Buscar Volunt√°rio</button>
  <button class="menu-button" onclick="showSection('presencaSubMenuSection')">‚úÖ Lista de Presen√ßa</button>
  <button class="menu-button" onclick="showSection('doacaoSubMenuSection')">üéÅ Cadastro de Doa√ß√µes</button>
  <button class="menu-button" onclick="showSection('dashboardSection')">üìä Dashboard</button>
</div>
</div>
  <div class="container">
    
    <div id="beneficiarioSection" class="app-section">
        <button class="back-button" onclick="showSection('mainMenu')">‚¨ÖÔ∏è Voltar ao Menu</button>
        <h2>Consulta e Atualiza√ß√£o de Atendidos</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="responsavelBusca">Nome Completo do Respons√°vel</label>
                <select id="responsavelBusca"> <option value="">Selecione um respons√°vel</option> </select>
            </div>
        </div>
        <button class="action-button" onclick="buscar(event)" style="background-color: var(--primary-color);">Buscar</button>
        <form id="updateForm" style="display:none; margin-top: 2rem;">
           <input type="hidden" id="idUnicoHidden">
            <fieldset>
              <legend>Dados do Respons√°vel</legend>
             <div class="form-row">
              <div class="form-group half"><label>Nome Completo</label><input type="text" id="respNomeCompleto" disabled></div>
              <div class="form-group half"><label>Data de Nascimento</label><input type="date" id="respDataNascimento"></div>
              <div class="form-group third"><label>CPF</label><input type="text" id="respCpf"></div>
              <div class="form-group third"><label>RG</label><input type="text" id="respRg"></div>
              <div class="form-group third"><label>Telefone de Contato</label><input type="tel" id="respTelefone"></div>
              <div class="form-group half"><label>E-mail</label><input type="email" id="respEmail"></div>
              <div class="form-group half"><label>Estado Civil</label><input type="text" id="respEstadoCivil"></div>
              <div class="form-group third">
                      <label for="voluntarioEscolaridade">Escolaridade</label>
                        <select id="respEscolaridade">
                            <option value="">Selecione a escolaridade</option>
                            <option value="Ensino fundamental incompleto">Ensino fundamental incompleto</option>
                            <option value="Ensino fundamental completo">Ensino fundamental completo</option>
                            <option value="Ensino m√©dio incompleto">Ensino m√©dio incompleto</option>
                            <option value="Ensino m√©dio completo">Ensino m√©dio completo</option>
                            <option value="Ensino superior incompleto">Ensino superior incompleto</option>
                            <option value="Ensino superior completo">Ensino superior completo</option>
                            <option value="P√≥s-gradua√ß√£o">P√≥s-gradua√ß√£o</option>
                        </select>
                </div>
              <div class="form-group third"><label>T√≠tulo de Eleitor</label><input type="text" id="tituloDeEleitor"></div>
              <div class="form-group third">
                <label for="respNacionalidade">Nacionalidade</label>
                <select id="nacionalidade">
                    <option value="">Selecione a nacionalidade</option>
                    <option value="Brasileiro">Brasileiro</option>
                    <option value="Brasileiro nascido no exterior ou naturalizado">Brasileiro nascido no exterior ou naturalizado</option>
                    <option value="Estrangeiro">Estrangeiro</option>
                </select>
              </div>
              <div class="form-group third"><label>Se Estrangeiro, Qual Pa√≠s de Origem?</label><input type="text" id="seEstrangeiroQualPaisOrigem"></div>
              <div class="form-group third"><label>Endere√ßo</label><input type="text" id="endereco"></div>
              <div class="form-group third"><label>Nome do C√¥njuge</label><input type="text" id="nomeDoConjuge"></div>
              <div class="form-group third"><label>Nome do Pai</label><input type="text" id="nomeDoPai"></div>
              <div class="form-group third"><label>Nome da M√£e</label><input type="text" id="nomeDaMae"></div>
              <div class="form-group third"><label>Religi√£o</label><input type="text" id="respReligiao"></div>
              <div class="form-group third"><label>Cor/Ra√ßa</label><input type="text" id="respCorRaca"></div>
              <div class="form-group"><label>Cidade de Nascimento</label><input type="text" id="respCidadeNascimento"></div>
          </div>
            </fieldset>
            <fieldset>
                <legend>Dependentes</legend>
                <div class="form-row">
                    <div class="form-group"><label>N√∫mero de Dependentes</label><input type="number" id="numeroDeDependentes"></div>
                </div>
                <div class="form-row">
                    <div class="form-group half"><label>Nome Dependente 1</label><input type="text" id="nomeDoDependente1"></div>
                    <div class="form-group half"><label>Data Nasc. Dependente 1</label><input type="date" id="dataDeNascimentoDependente1"></div>
                </div>
                <div class="form-row">
                    <div class="form-group half"><label>Nome Dependente 2</label><input type="text" id="nomeDoDependente2"></div>
                    <div class="form-group half"><label>Data Nasc. Dependente 2</label><input type="date" id="dataDeNascimentoDependente2"></div>
                </div>
                <div class="form-row">
                    <div class="form-group half"><label>Nome Dependente 3</label><input type="text" id="nomeDoDependente3"></div>
                    <div class="form-group half"><label>Data Nasc. Dependente 3</label><input type="date" id="dataDeNascimentoDependente3"></div>
                </div>
                <div class="form-row">
                    <div class="form-group half"><label>Nome Dependente 4</label><input type="text" id="nomeDoDependente4"></div>
                    <div class="form-group half"><label>Data Nasc. Dependente 4</label><input type="date" id="dataDeNascimentoDependente4"></div>
                </div>
                <div class="form-row">
                    <div class="form-group half"><label>Nome Dependente 5</label><input type="text" id="nomeDoDependente5"></div>
                    <div class="form-group half"><label>Data Nasc. Dependente 5</label><input type="date" id="dataDeNascimentoDependente5"></div>
                </div>
            </fieldset>
            <fieldset>
              <legend>Informa√ß√µes da Fam√≠lia</legend>
            <div class="form-row">
                <div class="form-group third"><label>N¬∫ de moradores da casa</label><input type="number" id="numMoradores"></div>
                <div class="form-group third"><label>Renda total da casa</label><input type="text" id="rendaTotal"></div>
                <div class="form-group third"><label>Cadastro no CAD√öNICO?</label><input type="text" id="cadunico"></div>
                <div class="form-group half"><label>Recebe benef√≠cio social?</label><input type="text" id="beneficioSocial"></div>
                <div class="form-group half"><label>CEP</label><input type="text" id="cep"></div>
                <div class="form-group third"><label>Estado</label><input type="text" id="estado"></div>
                <div class="form-group third"><label>Munic√≠pio</label><input type="text" id="municipio"></div>
                <div class="form-group third"><label>Bairro</label><input type="text" id="bairro"></div>
                <div class="form-group half"><label>Tipo de moradia</label><input type="text" id="tipoMoradia"></div>
                <div class="form-group half"><label>Abastecimento de √°gua</label><input type="text" id="abastecimentoAgua"></div>
                <div class="form-group half"><label>Saneamento b√°sico</label><input type="text" id="saneamentoBasico"></div>
                <div class="form-group half"><label>N¬∫ de c√¥modos na casa</label><input type="number" id="numComodos"></div>
                <div class="form-group"><label>Uso de subst√¢ncias psicoativas na casa?</label><input type="text" id="usoSubstancias"></div>
            </div>
            </fieldset>
            <div id="atendidosContainer"></div>
            <button type="button" id="addAtendidoBtn" onclick="addAtendido()" class="action-button" style="display: none; background-color: var(--secondary-color); margin-bottom: 1rem;">
              ‚ûï Adicionar Atendido
            </button>
            <div class="form-group" style="padding-top: 10px; padding-bottom: 10px;">
              <label for="cadastroAtivo">Cadastro ativo?</label>
              <select id="cadastroAtivo">
                  <option value="S">S</option>
                  <option value="N">N</option>
              </select>
            </div>
            <button class="action-button" type="button" onclick="atualizar(event)">Atualizar Dados</button>
            
        </form>
        <div id="mensagem" class="message-box"></div>
    </div>

    <div id="voluntarioSearchSection" class="app-section">
        <button class="back-button" onclick="showSection('mainMenu')">‚¨ÖÔ∏è Voltar ao Menu</button>
        <h2>Consulta e Atualiza√ß√£o de Volunt√°rio</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="voluntarioBusca">Nome Completo do Volunt√°rio</label>
                <select id="voluntarioBusca"> <option value="">Selecione um volunt√°rio</option> </select>
            </div>
        </div>
        <button class="action-button" onclick="buscarVoluntario(event)" style="background-color: var(--primary-color);">Buscar Volunt√°rio</button>
        
        <form id="updateVoluntarioForm" style="display:none; margin-top: 2rem;">
            <fieldset>
                <legend>Dados Pessoais</legend>
                <input type="hidden" id="voluntarioIdUnico">
                <div class="form-row">
                    <div class="form-group half"><label>Nome Completo</label><input type="text" id="voluntarioNomeCompleto"></div>
                    <div class="form-group half"><label>Data de Nascimento</label><input type="date" id="voluntarioDataNascimento"></div>
                    <div class="form-group third"><label>CPF</label><input type="text" id="voluntarioCpf"></div>
                    <div class="form-group third"><label>RG</label><input type="text" id="voluntarioRg"></div>
                    <div class="form-group third"><label>Nacionalidade</label><input type="text" id="voluntarioNacionalidade"></div>
                    <div class="form-group half">
                      <label for="voluntarioEscolaridade">Grau de escolaridade</label>
                        <select id="voluntarioEscolaridade">
                            <option value="">Selecione a escolaridade</option>
                            <option value="Ensino fundamental incompleto">Ensino fundamental incompleto</option>
                            <option value="Ensino fundamental completo">Ensino fundamental completo</option>
                            <option value="Ensino m√©dio incompleto">Ensino m√©dio incompleto</option>
                            <option value="Ensino m√©dio completo">Ensino m√©dio completo</option>
                            <option value="Ensino superior incompleto">Ensino superior incompleto</option>
                            <option value="Ensino superior completo">Ensino superior completo</option>
                            <option value="P√≥s-gradua√ß√£o">P√≥s-gradua√ß√£o</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Religi√£o</label><input type="text" id="voluntarioReligiao"></div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Endere√ßo</legend>
                <div class="form-row">
                    <div class="form-group half"><label>Endere√ßo</label><input type="text" id="voluntarioEndereco"></div>
                    <div class="form-group half"><label>Bairro</label><input type="text" id="voluntarioBairro"></div>
                    <div class="form-group half"><label>Cidade</label><input type="text" id="voluntarioCidade"></div>
                    <div class="form-group half"><label>Estado</label><input type="text" id="voluntarioEstado"></div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Informa√ß√µes de Voluntariado</legend>
                <div class="form-row">
                    <div class="form-group"><label>Atividade que vai realizar na institui√ß√£o</label><input type="text" id="voluntarioAtividade"></div>
                    <div class="form-group half">
                        <label for="voluntarioDisponibilidade">Disponibilidade de hor√°rio</label>
                        <select id="voluntarioDisponibilidade">
                            <option value="">Selecione um hor√°rio</option>
                            <option value="Manh√£">Manh√£</option>
                            <option value="Tarde">Tarde</option>
                            <option value="Noite">Noite</option>
                        </select>
                    </div>
                    <div class="form-group half"><label>Vai atuar em quais dias?</label><input type="text" id="voluntarioDias"></div>
                    <div class="form-group half"><label>J√° foi volunt√°rio anteriormente?</label><input type="text" id="voluntarioJaFoi"></div>
                    <div class="form-group half"><label>Deseja ajudar com alguma contribui√ß√£o?</label><input type="text" id="voluntarioContribuicao"></div>
                </div>
                <div class="form-row" style="padding-top: 10px; padding-bottom: 10px;">
                  <div class="form-group"><label for="voluntarioAtivo">Cadastro ativo?</label>
                    <select id="voluntarioAtivo">
                        <option value="S">S</option>
                        <option value="N">N</option>
                    </select>
                  </div>
                </div>
            </fieldset>
            <button class="action-button" type="button" onclick="atualizarVoluntario(event)">Atualizar Volunt√°rio</button>
        </form>
        <div id="mensagem-voluntario" class="message-box"></div>
    </div>

    <div id="presencaSubMenuSection" class="app-section">
        <button class="back-button" onclick="showSection('mainMenu')">‚¨ÖÔ∏è Voltar ao Menu Principal</button>
        <h2>Lista de Presen√ßa</h2>
        <div class="main-menu">
            <button class="menu-button" onclick="showSection('presencaRegisterSection')">‚ûï Registrar Presen√ßa</button>
            <button class="menu-button" onclick="showSection('presencaConsultSection')">üîé Consultar Presen√ßa</button>
        </div>
    </div>

    <div id="presencaRegisterSection" class="app-section">
        <button class="back-button" onclick="showSection('presencaSubMenuSection')">‚¨ÖÔ∏è Voltar para Lista de Presen√ßa</button>
        <h2>Registrar Presen√ßa</h2>
        
        <fieldset>
            <legend>Selecione a Data e o Turno</legend>
            <div class="form-row">
                <div class="form-group half">
                    <label for="presencaData">Data da Chamada</label>
                    <input type="date" id="presencaData">
                </div>
                <div class="form-group half">
                    <label for="presencaTurno">Turno</label>
                    <select id="presencaTurno">
                        <option value="">Selecione um turno</option>
                        <option value="Manh√£">Manh√£</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                    </select>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Marque a Presen√ßa dos Atendidos</legend>
            <div id="listaAtendidosContainer"><p>Carregando lista de atendidos...</p></div>
        </fieldset>

        <button class="action-button" onclick="salvarPresenca()">Salvar Presen√ßa</button>
        <div id="mensagem-presenca" class="message-box" style="margin-top: 20px;"></div>
    </div>
    
    <div id="presencaConsultSection" class="app-section">
        <button class="back-button" onclick="showSection('presencaSubMenuSection')">‚¨ÖÔ∏è Voltar para Lista de Presen√ßa</button>
        <h2>Consultar Lista de Presen√ßa</h2>

        <fieldset>
            <legend>Filtros da Busca</legend>
            <div class="form-row">
                <div class="form-group half">
                    <label for="consultaData">Data</label>
                    <input type="date" id="consultaData">
                </div>
                <div class="form-group half">
                    <label for="consultaTurno">Turno</label>
                    <select id="consultaTurno">
                        <option value="">Selecione um turno</option>
                        <option value="Manh√£">Manh√£</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                    </select>
                </div>
            </div>
        </fieldset>

        <button class="action-button" onclick="consultarPresenca()" style="background-color: var(--primary-color);">Buscar Presen√ßas</button>
        
        <div id="presencaResultsContainer" style="margin-top: 2rem;">
            </div>
        <div id="mensagem-consulta" class="message-box"></div>
    </div>

    <div id="doacaoSubMenuSection" class="app-section">
        <button class="back-button" onclick="showSection('mainMenu')">‚¨ÖÔ∏è Voltar ao Menu Principal</button>
        <h2>Cadastro de Doa√ß√µes</h2>
        <div class="main-menu">
            <button class="menu-button" onclick="showSection('doacaoRegisterSection')">‚ûï Registrar Recebimento</button>
            <button class="menu-button" onclick="showSection('doacaoConsultSection')">üîé Consultar Recebimentos</button>
        </div>
    </div>
    
    <div id="doacaoRegisterSection" class="app-section">
        <button class="back-button" onclick="showSection('doacaoSubMenuSection')">‚¨ÖÔ∏è Voltar</button>
        <h2>Registrar Recebimento de Doa√ß√£o</h2>
        <form id="formRegistrarDoacao">
            <fieldset>
                <legend>Detalhes da Doa√ß√£o</legend>
                <div class="form-row">
                    <div class="form-group"><label for="doacaoDescricao">Doa√ß√£o</label><textarea id="doacaoDescricao" rows="3"></textarea></div>
                    <div class="form-group half"><label for="doacaoDataRecebimento">Data do Recebimento</label><input type="date" id="doacaoDataRecebimento"></div>
                    <div class="form-group half"><label for="doacaoRecebidoPor">Recebido Por (Respons√°vel)</label><select id="doacaoRecebidoPor"></select></div>
                    <input type="hidden" id="doacaoRecebidoPorId">
                    <div class="form-group"><label for="doacaoDataEntrega">Data da Entrega (Opcional)</label><input type="date" id="doacaoDataEntrega"></div>
                </div>
            </fieldset>
            <button class="action-button" type="button" onclick="registrarDoacao(event)">Salvar Registro</button>
        </form>
        <div id="mensagem-doacao-reg" class="message-box"></div>
    </div>

    <div id="doacaoConsultSection" class="app-section">
        <button class="back-button" onclick="showSection('doacaoSubMenuSection')">‚¨ÖÔ∏è Voltar</button>
        <h2>Consultar Doa√ß√µes Recebidas</h2>
        <fieldset>
    <legend>Filtros</legend>
          <div class="form-row">
              <div class="form-group half">
                  <label for="doacaoFiltroInicio">Data de In√≠cio</label>
                  <input type="date" id="doacaoFiltroInicio">
              </div>
              <div class="form-group half">
                  <label for="doacaoFiltroFim">Data de Fim</label>
                  <input type="date" id="doacaoFiltroFim">
              </div>
          </div>
          
          <!-- ADD THIS NEW FILTER BLOCK -->
          <div class="form-row" style="margin-top: 1rem;">
              <div class="form-group">
                  <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                      <input type="checkbox" id="doacaoFiltroPendentes" style="width: auto; height: 1.2em; margin-right: 10px;">
                      Mostrar apenas doa√ß√µes pendentes de entrega
                  </label>
              </div>
          </div>
      </fieldset>
        <button class="action-button" onclick="consultarDoacoes()" style="background-color: var(--primary-color);">Buscar Doa√ß√µes</button>
        <div id="doacoesResultsContainer" style="margin-top: 2rem;"></div>
        <div id="doacoesPaginationContainer" style="display: flex; justify-content: space-between; margin-top: 1rem;"></div>
        <div id="mensagem-doacao-con" class="message-box"></div>
    </div>
    <div id="dashboardSection" class="app-section">
      <button class="back-button" onclick="showSection('mainMenu')">‚¨ÖÔ∏è Voltar ao Menu</button>
      <h2>üìä Dashboard</h2>
      
      <div class="stats-container">
      <div class="stat-card">
        <div class="stat-icon">üë®‚Äçüë©‚Äçüëß</div>
        <div class="stat-info">
          <div class="stat-title">Total de Respons√°veis</div>
          <div class="stat-number" id="stat-total-responsaveis">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background-color: #d4edda; color: #155724;">‚úÖ</div>
        <div class="stat-info">
          <div class="stat-title">Respons√°veis Ativos</div>
          <div class="stat-number" id="stat-active-responsaveis">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üëß</div>
        <div class="stat-info">
          <div class="stat-title">Total de Atendidos</div>
          <div class="stat-number" id="stat-total-atendidos">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background-color: #d4edda; color: #155724;">‚úÖ</div>
        <div class="stat-info">
          <div class="stat-title">Atendidos Ativos</div>
          <div class="stat-number" id="stat-active-atendidos">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üßë‚Äçü§ù‚Äçüßë</div>
        <div class="stat-info">
          <div class="stat-title">Total de Volunt√°rios</div>
          <div class="stat-number" id="stat-total-voluntarios">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background-color: #d4edda; color: #155724;">‚úÖ</div>
        <div class="stat-info">
          <div class="stat-title">Volunt√°rios Ativos</div>
          <div class="stat-number" id="stat-active-voluntarios">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üéÅ</div>
        <div class="stat-info">
          <div class="stat-title">Total de Doa√ß√µes</div>
          <div class="stat-number" id="stat-donations">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚òÄÔ∏è</div>
        <div class="stat-info">
          <div class="stat-title">M√©dia Manh√£</div>
          <div class="stat-number" id="stat-avg-manha">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üåá</div>
        <div class="stat-info">
          <div class="stat-title">M√©dia Tarde</div>
          <div class="stat-number" id="stat-avg-tarde">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üåô</div>
        <div class="stat-info">
          <div class="stat-title">M√©dia Noite</div>
          <div class="stat-number" id="stat-avg-noite">...</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-info">
          <div class="stat-title">M√©dia de Presen√ßa</div>
          <div class="stat-number" id="stat-attendance">...</div>
        </div>
      </div>
    </div>
        <div class="list-container" id="atendidoAttendanceListContainer">
        </div>
      </div>
      
    </div>
  <script>
    let visibleAtendidosCount = 0;

    /**
     * Shows the next available 'Atendido' form section.
     */
    function addAtendido() {
      // We only add if there are fewer than 5 visible
      if (visibleAtendidosCount < 5) {
        visibleAtendidosCount++;
        
        const nextSection = document.getElementById(`atendido${visibleAtendidosCount}Section`);
        if (nextSection) {
          nextSection.style.display = 'block';
        }

        // If we've just shown the 5th section, hide the "add" button
        if (visibleAtendidosCount >= 5) {
          document.getElementById('addAtendidoBtn').style.display = 'none';
        }
      }
    }

    function onFailure(error) {
      console.error("Erro ao carregar dados: " + error.message);
      // Hide loading indicator and show an error message to the user
    }

    function showSection(sectionIdToShow) {
        document.getElementById('mainMenu').style.display = 'none';
        document.querySelectorAll('.app-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(sectionIdToShow).style.display = 'block';

        // L√≥gica para carregar dados quando uma se√ß√£o espec√≠fica √© aberta
        if (sectionIdToShow === 'presencaRegisterSection') {
            const dataInput = document.getElementById('presencaData');
            if (!dataInput.value) { dataInput.valueAsDate = new Date(); }
            carregarListaDePresenca();
        } else if (sectionIdToShow === 'doacaoRegisterSection' || sectionIdToShow === 'doacaoConsultSection') {
            populateResponsaveisDropdown();
        } else if (sectionIdToShow === 'dashboardSection') { // ADD THIS BLOCK
            loadDashboard(); // This function creates the chart
        }

        if (sectionIdToShow === 'doacaoRegisterSection') {
            document.getElementById('formRegistrarDoacao').reset();
        }
    }

    // --- L√ìGICA GERAL ---
    window.addEventListener('load', function() {
      gerarFormulariosAtendidos();
      
      // Popula dropdown de atendidos
      google.script.run.withSuccessHandler(populateBeneficiaryList).listarBeneficiarios();
      
      // Popula dropdown de volunt√°rios (com o nome corrigido)
      google.script.run.withSuccessHandler(populateVoluntarioList).listarVoluntarios();
    });

    function showMessage(text, type, elementId = 'mensagem') {
        const msgBox = document.getElementById(elementId);
        if (msgBox) {
            msgBox.textContent = text;
            msgBox.className = 'message-box ' + type;
            msgBox.style.display = text ? 'block' : 'none';
        }
    }

    // ==========================================================
    // --- L√ìGICA DOS ATENDIDOS ---
    // ==========================================================
    const ALL_FORM_IDS = [
      'respNomeCompleto', 'respDataNascimento', 'respCpf', 'respRg', 'respTelefone', 'respEmail', 'respEstadoCivil', 'respEscolaridade', 'respReligiao', 'nacionalidade', 'seEstrangeiroQualPaisOrigem',
      'endereco', 'nomeDoConjuge', 'nomeDoPai', 'nomeDaMae', 'respCorRaca', 'respCidadeNascimento',
      'numMoradores', 'rendaTotal', 'cadunico', 'beneficioSocial', 'cep', 'estado', 'municipio', 'bairro', 'tipoMoradia', 'abastecimentoAgua', 'saneamentoBasico', 'numComodos', 'usoSubstancias', 'cadastroAtivo',
      'numeroDeDependentes', 'nomeDoDependente1', 'dataDeNascimentoDependente1', 'nomeDoDependente2','dataDeNascimentoDependente2', 'nomeDoDependente3', 'dataDeNascimentoDependente3', 'nomeDoDependente4', 'dataDeNascimentoDependente4', 'nomeDoDependente5', 'dataDeNascimentoDependente5'
    ];
    const ATENDIDO_FIELDS_CONFIG = [
        {id: 'NomeCompleto', label: 'Nome Completo', type: 'text', class: ''},
        {id: 'Cpf', label: 'CPF', type: 'text', class: 'half'},
        {id: 'Rg', label: 'RG', type: 'text', class: 'half'},
        {id: 'CorRaca', label: 'Cor/Ra√ßa', type: 'text', class: 'third'},
        {id: 'TurnoAtividades', label: 'Turno na institui√ß√£o', type: 'text', class: 'third'},
        {id: 'DataDeNascimento', label: 'Data de Nascimento', type: 'date', class: 'third'},
        {id: 'Escolaridade', label: 'Escolaridade', type: 'text', class: 'half'},
        {id: 'NomeDaEscola', label: 'Nome da Escola', type: 'text', class: 'half'},
        {id: 'PodeSairSozinha', label: 'Pode sair sozinho(a)?', type: 'text', class: 'half'},
        {id: 'QuemEstaAutorizadoABuscar', label: 'Quem pode buscar?', type: 'text', class: 'half'},
        {id: 'CertidaoDeNascimento', label: 'Certid√£o de Nascimento', type: 'text', class: ''},
        {id: 'RestricaoAlimentar', label: 'Restri√ß√£o Alimentar?', type: 'text'},
        {id: 'ProblemaDeSaude', label: 'Problema de Sa√∫de?', type: 'text'},
        {id: 'RemedioDeUsoContinuo', label: 'Usa Rem√©dio Cont√≠nuo?', type: 'text'},
        {id: 'JaFezAlgumaCirurgia', label: 'J√° fez cirurgia?', type: 'text'},
        {id: 'PossuiAlgumTipoDeDeficiencia', label: 'Possui defici√™ncia?', type: 'text'},
        {id: 'AtividadesNaInstituicao', label: 'Participar√° de quais atividades?', type: 'text', class: ''},
        {id: 'TamanhoDaCamiseta', label: 'Tamanho da Camiseta', type: 'text', class: 'third'},
        {id: 'TamanhoDaCalca', label: 'Tamanho da Cal√ßa', type: 'text', class: 'third'},
        {id: 'TamanhoDoSapato', label: 'Tamanho do Sapato', type: 'text', class: 'third'}
    ];
    function gerarFormulariosAtendidos() {
        const container = document.getElementById('atendidosContainer');
        if (container.innerHTML !== '') return;
        for (let i = 1; i <= 5; i++) {
            const fieldset = document.createElement('fieldset');
            fieldset.id = `atendido${i}Section`;
            fieldset.className = 'atendido-section';
            const legend = document.createElement('legend');
            legend.textContent = `Atendido ${i}`;
            fieldset.appendChild(legend);
            const formRow = document.createElement('div');
            formRow.className = 'form-row';
            ATENDIDO_FIELDS_CONFIG.forEach(field => {
                const id = `atendido${i}${field.id}`;
                ALL_FORM_IDS.push(id);
                const formGroup = document.createElement('div');
                formGroup.className = `form-group ${field.class || ''}`;
                formGroup.innerHTML = `<label for="${id}">${field.label}</label><input type="${field.type}" id="${id}">`;
                formRow.appendChild(formGroup);
            });
            fieldset.appendChild(formRow);
            container.appendChild(fieldset);
        }
    }

        /**
     * Popula o dropdown de busca de respons√°veis.
     * @param {Array<{displayName: string, searchName: string}>} beneficiarios
     */
    function populateBeneficiaryList(beneficiarios) {
      const select = document.getElementById("responsavelBusca");
      select.length = 1; // Limpa op√ß√µes antigas, mantendo "Selecione..."

      beneficiarios.forEach(beneficiario => {
        if (beneficiario && beneficiario.displayName && beneficiario.searchName) {
          // Use .displayName for the text the user sees
          // Use .searchName for the value that is sent to the server
          const option = new Option(beneficiario.displayName, beneficiario.searchName);
          select.add(option);
        }
      });
    }

    function buscar(event) {
        const nome = document.getElementById("responsavelBusca").value;
        if (!nome) { showMessage('Por favor, selecione um respons√°vel.', 'error'); return; }
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Buscando...';
        showMessage('', '');
        
        google.script.run
          .withSuccessHandler(function(data) {
            if (!data || data.error) {
              showMessage(data ? data.error : 'Erro no servidor.', 'error');
              document.getElementById('updateForm').style.display = 'none';
            } else {
              // --- THIS IS THE UPDATED LOGIC ---
              
              // 1. Reset the counter for each new search
              visibleAtendidosCount = 0;
              
              // 2. Populate the form fields as before
              for (const key in data) {
                const element = document.getElementById(key);
                if (element) {
                  element.value = data[key] || '';
                }
              }
              document.getElementById('idUnicoHidden').value = data.idUnico;
              
              // 3. Show/hide sections AND count how many are visible
              for (let i = 1; i <= 5; i++) {
                const section = document.getElementById(`atendido${i}Section`);
                if (section) {
                  if (data[`atendido${i}NomeCompleto`]) {
                    section.style.display = 'block';
                    visibleAtendidosCount++; // Increment counter for visible sections
                  } else {
                    section.style.display = 'none';
                  }
                }
              }

              // 4. Show or hide the "Add Atendido" button based on the count
              const addBtn = document.getElementById('addAtendidoBtn');
              if (visibleAtendidosCount < 5) {
                addBtn.style.display = 'block';
              } else {
                addBtn.style.display = 'none';
              }

              document.getElementById('updateForm').style.display = 'block';
            }
            btn.disabled = false;
            btn.textContent = 'Buscar';
          })
          .withFailureHandler(function(err) {
            showMessage('Erro ao buscar: ' + err.message, 'error');
            btn.disabled = false;
            btn.textContent = 'Buscar';
          })
          .buscarBeneficiario(nome);
      }

    function atualizar(event) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Atualizando...';
      const dados = {};
      ALL_FORM_IDS.forEach(id => {
        const element = document.getElementById(id);
        if(element) dados[id] = element.value;
      });
      dados.idUnico = document.getElementById('idUnicoHidden').value;
      google.script.run
        .withSuccessHandler(function(msg) {
          showMessage(msg, msg.startsWith('Erro') ? 'error' : 'success');
          btn.disabled = false;
          btn.textContent = 'Atualizar Dados';
        })
        .withFailureHandler(function(err) {
          showMessage('Erro ao atualizar: ' + err.message, 'error');
          btn.disabled = false;
          btn.textContent = 'Atualizar Dados';
        })
        .atualizarBeneficiario(dados);
    }
    
    // ==========================================================
    // --- L√ìGICA DOS VOLUNT√ÅRIOS ---
    // ==========================================================

    function populateVoluntarioList(voluntarios) {
        const select = document.getElementById("voluntarioBusca");
        select.length = 1;
        voluntarios.forEach(voluntario => {
            if (voluntario && voluntario.name) {
                const option = new Option(voluntario.name, voluntario.id); 
                select.add(option);
            }
        });
    }

    function buscarVoluntario(event) {
        const voluntarioId = document.getElementById("voluntarioBusca").value;
        if (!voluntarioId) {
            showMessage('Por favor, selecione um volunt√°rio.', 'error', 'mensagem-voluntario');
            return;
        }
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Buscando...';
        showMessage('', 'info', 'mensagem-voluntario');

        google.script.run
            .withSuccessHandler(function(data) {
                const form = document.getElementById('updateVoluntarioForm');
                if (data.error) {
                    showMessage(data.error, 'error', 'mensagem-voluntario');
                    if(form) form.style.display = 'none';
                } else {
                    for (const key in data) {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = data[key] || '';
                        }
                    }
                    if(form) form.style.display = 'block';
                }
                btn.disabled = false;
                btn.textContent = 'Buscar Volunt√°rio';
            })
            .withFailureHandler(function(err) {
                showMessage('Erro ao buscar: ' + err.message, 'error', 'mensagem-voluntario');
                btn.disabled = false;
                btn.textContent = 'Buscar Volunt√°rio';
            })
            .buscarVoluntarioPorId(voluntarioId);
    }

    function atualizarVoluntario(event) {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Atualizando...';
        const dados = {
            voluntarioIdUnico: document.getElementById('voluntarioIdUnico').value,
            voluntarioNomeCompleto: document.getElementById('voluntarioNomeCompleto').value,
            voluntarioDataNascimento: document.getElementById('voluntarioDataNascimento').value,
            voluntarioCpf: document.getElementById('voluntarioCpf').value,
            voluntarioRg: document.getElementById('voluntarioRg').value,
            voluntarioNacionalidade: document.getElementById('voluntarioNacionalidade').value,
            voluntarioAtividade: document.getElementById('voluntarioAtividade').value,
            voluntarioEndereco: document.getElementById('voluntarioEndereco').value,
            voluntarioBairro: document.getElementById('voluntarioBairro').value,
            voluntarioCidade: document.getElementById('voluntarioCidade').value,
            voluntarioEstado: document.getElementById('voluntarioEstado').value,
            voluntarioJaFoi: document.getElementById('voluntarioJaFoi').value,
            voluntarioDisponibilidade: document.getElementById('voluntarioDisponibilidade').value,
            voluntarioDias: document.getElementById('voluntarioDias').value,
            voluntarioEscolaridade: document.getElementById('voluntarioEscolaridade').value,
            voluntarioReligiao: document.getElementById('voluntarioReligiao').value,
            voluntarioAtivo: document.getElementById('voluntarioAtivo').value,
            voluntarioContribuicao: document.getElementById('voluntarioContribuicao').value
        };

        google.script.run
            .withSuccessHandler(function(msg) {
                showMessage(msg, msg.startsWith('Erro') ? 'error' : 'success', 'mensagem-voluntario');
                btn.disabled = false;
                btn.textContent = 'Atualizar Volunt√°rio';
            })
            .withFailureHandler(function(err) {
                showMessage('Erro ao atualizar: ' + err.message, 'error', 'mensagem-voluntario');
                btn.disabled = false;
                btn.textContent = 'Atualizar Volunt√°rio';
            })
            .atualizarVoluntario(dados);
    }

    // ==========================================================
    // --- L√ìGICA DA LISTA DE PRESEN√áA ---
    // ==========================================================
    
    let listaPresencaCarregada = false; // Vari√°vel de controle

    /**
     * Busca a lista de atendidos ativos e os exibe na tela com checkboxes.
     * Roda apenas uma vez para n√£o sobrecarregar o sistema.
     */
    function carregarListaDePresenca() {
        if (listaPresencaCarregada) return; // N√£o carrega a lista se j√° foi carregada

        const container = document.getElementById('listaAtendidosContainer');
        container.innerHTML = '<p>Carregando lista de atendidos...</p>';
        
        google.script.run
            .withSuccessHandler(function(nomes) {
                container.innerHTML = ''; // Limpa a mensagem de "carregando"
                if (nomes && nomes.length > 0) {
                  nomes.forEach(nome => {
                      const div = document.createElement('div');
                      // Add styles to make the row look clean
                      div.style.display = 'flex';
                      div.style.alignItems = 'center';
                      div.style.justifyContent = 'space-between';
                      div.style.marginBottom = '10px';

                      // This creates the name label and the dropdown
                      div.innerHTML = `
                          <label for="status-${nome}" style="flex-grow: 1; margin: 0;">${nome}</label>
                          <input type="text" id="obs-${nome}" class="presenca-obs" placeholder="Observa√ß√µes" style="flex-basis: 150px; margin-left: 8px;">
                          <select id="status-${nome}" class="presenca-select" data-name="${nome}" style="flex-basis: 130px;">
                              <option value="" selected>(Selecione)</option>
                              <option value="Presente">Presente</option>
                              <option value="Ausente">Ausente</option>
                          </select>
                      `;
                      container.appendChild(div);
                  });
                } else {
                    container.innerHTML = '<p>Nenhum atendido ativo encontrado.</p>';
                }
            })
            .withFailureHandler(function(err) {
                container.innerHTML = `<p style="color: red;">Erro ao carregar lista: ${err.message}</p>`;
            })
            .listarAtendidosAtivos();
    }

    function salvarPresenca() {
        const btn = event.target;
        const selectedDate = document.getElementById('presencaData').value;
        const selectedTurno = document.getElementById('presencaTurno').value;

        if (!selectedDate || !selectedTurno) {
            showMessage('Por favor, selecione a data e o turno.', 'error', 'mensagem-presenca');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Salvando...';

        // 1. Find all dropdowns with the class 'presenca-select'
        const selects = document.querySelectorAll('#listaAtendidosContainer .presenca-select');

        // 2. Map them to a name/status object
        const presencas = Array.from(selects).map(sel => {
            const nome = sel.dataset.name;
            
            const obsInput = document.getElementById(`obs-${nome}`);

            return {
                name: sel.dataset.name,  // Get the name from the data-name attribute
                status: sel.value, // "Presente", "Ausente", ou ""
                observacoes: obsInput ? obsInput.value : ''
            };
        });

        // 3. Filter out any entries where the status is blank (left as "Selecione")
        const presencasParaSalvar = presencas.filter(p => p.status !== "");

        const dadosParaSalvar = {
            date: selectedDate,
            turno: selectedTurno,
            presencas: presencasParaSalvar // Send the filtered list
        };
        
        // Check if any attendance was actually marked
        if (presencasParaSalvar.length === 0) {
            showMessage('Nenhuma presen√ßa ou aus√™ncia foi marcada.', 'error', 'mensagem-presenca');
            btn.disabled = false;
            btn.textContent = 'Salvar Presen√ßa';
            return;
        }
        console.log(dadosParaSalvar);
        google.script.run
            .withSuccessHandler(function(msg) {
                showMessage(msg, msg.startsWith('Erro') ? 'success' : 'success', 'mensagem-presenca');
                btn.disabled = false;
                btn.textContent = 'Salvar Presen√ßa';
                // Optional: reset all dropdowns back to blank
                selects.forEach(sel => sel.value = "");
            })
            .withFailureHandler(function(err) {
                showMessage('Erro ao salvar: ' + err.message, 'error', 'mensagem-presenca');
                btn.disabled = false;
                btn.textContent = 'Salvar Presen√ßa';
            })
            .salvarPresenca(dadosParaSalvar);
    }

    // --- L√ìGICA DA LISTA DE PRESEN√áA ---
    // (Suas fun√ß√µes carregarListaDePresenca e salvarPresenca continuam aqui)
    
    
    // --- NOVAS FUN√á√ïES PARA CONSULTA DE PRESEN√áA ---
    function consultarPresenca() {
        const btn = event.target;
        const selectedDate = document.getElementById('consultaData').value;
        const selectedTurno = document.getElementById('consultaTurno').value;

        if (!selectedDate || !selectedTurno) {
            showMessage('Por favor, selecione a data e o turno.', 'error', 'mensagem-consulta');
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Buscando...';
        showMessage('', 'info', 'mensagem-consulta');
        document.getElementById('presencaResultsContainer').innerHTML = ''; // Limpa resultados antigos

        google.script.run
            .withSuccessHandler(function(resultados) {
                if(resultados.error) {
                    showMessage(resultados.error, 'error', 'mensagem-consulta');
                } else {
                    exibirResultadosPresenca(resultados);
                }
                btn.disabled = false;
                btn.textContent = 'Buscar Presen√ßas';
            })
            .withFailureHandler(function(err) {
                showMessage('Erro ao consultar: ' + err.message, 'error', 'mensagem-consulta');
                btn.disabled = false;
                btn.textContent = 'Buscar Presen√ßas';
            })
            .consultarPresenca({ date: selectedDate, turno: selectedTurno });
    }

    function exibirResultadosPresenca(resultados) {
        const container = document.getElementById('presencaResultsContainer');
        container.innerHTML = '';

        if (!resultados || resultados.length === 0) {
            container.innerHTML = '<p>Nenhum registro de presen√ßa encontrado para esta data e turno.</p>';
            return;
        }

        const table = document.createElement('table');
        table.className = 'responsive-table'; // Add this line
        table.style.width = '100%'; 
        table.style.borderCollapse = 'collapse';
        table.innerHTML = `
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Nome Completo</th>
                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Observa√ß√µes</th>
                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Status</th>
                </tr>
            </thead>
        `;

        const tbody = document.createElement('tbody');
        resultados.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">${item.observacoes || ''}</td>
                <td style="padding: 8px; border: 1px solid #ddd; color: ${item.status === 'Presente' ? 'green' : 'red'};">${item.status}</td>
            `;
            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.appendChild(table);
    }
    

    // ==========================================================
    // --- L√ìGICA DO CADASTRO DE DOA√á√ïES ---
    // ==========================================================
    
    let responsaveisCarregados = false;
    let responsaveisLista = [];

    function populateResponsaveisDropdown() {
        if (responsaveisCarregados) return;
        google.script.run.withSuccessHandler(function(lista) {
            responsaveisLista = lista;
            const select = document.getElementById('doacaoRecebidoPor');
            select.innerHTML = '<option value="">Selecione um respons√°vel</option>';
            lista.forEach(r => select.add(new Option(r.name, r.id)));
            responsaveisCarregados = true;
        }).listarResponsaveisComId();
    }
    
    function registrarDoacao(event) {
        const btn = event.target;
        const selectedId = document.getElementById('doacaoRecebidoPor').value;
        const selectedResponsavel = responsaveisLista.find(r => r.id === selectedId);

        const dados = {
            doacao: document.getElementById('doacaoDescricao').value,
            dataRecebimento: document.getElementById('doacaoDataRecebimento').value,
            recebidoPorNome: selectedResponsavel ? selectedResponsavel.name : '',
            recebidoPorId: selectedId,
            dataEntrega: document.getElementById('doacaoDataEntrega').value
        };

        if (!dados.doacao || !dados.dataRecebimento) {
            showMessage('Preencha os campos Doa√ß√£o e Data.', 'error', 'mensagem-doacao-reg');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Salvando...';

        google.script.run.withSuccessHandler(function(msg) {
            showMessage(msg, 'success', 'mensagem-doacao-reg');
            document.getElementById('formRegistrarDoacao').reset();
            btn.disabled = false;
            btn.textContent = 'Salvar Registro';
        }).withFailureHandler(function(err) {
            showMessage('Erro: ' + err.message, 'error', 'mensagem-doacao-reg');
        }).registrarDoacao(dados);
    }
    
    function consultarDoacoes(page = 1) {
      const startDate = document.getElementById('doacaoFiltroInicio').value;
      const endDate = document.getElementById('doacaoFiltroFim').value;
      // Get the status of the new checkbox (true or false)
      const pendentes = document.getElementById('doacaoFiltroPendentes').checked; 
      
      showMessage('', 'info', 'mensagem-doacao-con');

      google.script.run.withSuccessHandler(function(result) {
          if (result.error) {
              showMessage(result.error, 'error', 'mensagem-doacao-con');
              return;
          }
          exibirResultadosDoacoes(result.doacoes);
          renderizarPaginacaoDoacoes(result.currentPage, result.totalRecords, result.pageSize);
      })
      // Add the new 'pendentes' property to the object sent to the server
      .consultarDoacoes({ 
          startDate: startDate, 
          endDate: endDate, 
          page: page,
          pendentes: pendentes 
      });
  }

 function exibirResultadosDoacoes(doacoes) {
    const container = document.getElementById('doacoesResultsContainer');
    container.innerHTML = '';
    if (!doacoes || doacoes.length === 0) {
        container.innerHTML = '<p>Nenhuma doa√ß√£o encontrada para os filtros aplicados.</p>';
        return;
    }

    // 1. Create the table and its header
    const table = document.createElement('table');
    table.className = 'responsive-table'; // Make sure this class is here for mobile styles
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.innerHTML = `<thead><tr style="background-color: #f2f2f2;">
            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Doa√ß√£o</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Data Receb.</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Recebido Por</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Data Entrega</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">A√ß√£o</th>
        </tr></thead>`;

    // 2. Create the table body ONCE, before the loop
    const tbody = document.createElement('tbody');

    // 3. Loop through donations to create and add each row (tr) to the tbody
    doacoes.forEach(d => {
        const tr = document.createElement('tr');
        tr.id = `doacao-row-${d.id}`;
        if (d.dataEntrega) {
            tr.style.backgroundColor = '#d4edda';
        }

        // --- Create each cell (<td>) and append it to the row (tr) ---
        const tdDoacao = document.createElement('td');
        tdDoacao.setAttribute('data-label', 'Doa√ß√£o');
        tdDoacao.textContent = d.doacao;
        tr.appendChild(tdDoacao);

        const tdDataReceb = document.createElement('td');
        tdDataReceb.setAttribute('data-label', 'Data Receb.');
        tdDataReceb.textContent = d.dataRecebimento;
        tr.appendChild(tdDataReceb);

        const tdRecebidoPor = document.createElement('td');
        tdRecebidoPor.setAttribute('data-label', 'Recebido Por');
        const select = document.createElement('select');
        select.id = `select-recebido-${d.id}`;
        const placeholderOption = `<option value="" disabled ${!d.idUnicoResponsavel ? 'selected' : ''}>Selecione...</option>`;
        const personOptions = responsaveisLista.map(r =>
            `<option value="${r.id}" ${r.id === d.idUnicoResponsavel ? 'selected' : ''}>${r.name}</option>`
        ).join('');
        select.innerHTML = placeholderOption + personOptions;
        tdRecebidoPor.appendChild(select);
        tr.appendChild(tdRecebidoPor);

        const tdDataEntrega = document.createElement('td');
        tdDataEntrega.setAttribute('data-label', 'Data Entrega');
        const inputDate = document.createElement('input');
        inputDate.type = 'date';
        inputDate.id = `input-entrega-${d.id}`;
        inputDate.value = d.dataEntrega;
        tdDataEntrega.appendChild(inputDate);
        tr.appendChild(tdDataEntrega);

        const tdAcao = document.createElement('td');
        tdAcao.setAttribute('data-label', 'A√ß√£o');
        const button = document.createElement('button');
        button.textContent = 'Salvar';
        button.onclick = function() {
            salvarEdicaoDoacao(d.id);
        };
        tdAcao.appendChild(button);
        tr.appendChild(tdAcao);
        
        // CORRECTION: Add the completed row to the tbody INSIDE the loop
        tbody.appendChild(tr);
    });

    // 4. AFTER the loop, add the populated tbody to the table
    table.appendChild(tbody);
    
    // 5. AFTER building the whole table, add it to the page container
    container.appendChild(table);
}
    function salvarEdicaoDoacao(doacaoId) {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '...';

        const select = document.getElementById(`select-recebido-${doacaoId}`);
        const selectedId = select.value;
        const selectedName = select.options[select.selectedIndex].text;
        const novaDataEntrega = document.getElementById(`input-entrega-${doacaoId}`).value;

        const dados = {
            doacaoId: doacaoId,
            recebidoPorId: selectedId,
            recebidoPorNome: selectedName,
            dataEntrega: novaDataEntrega
        };

        google.script.run.withSuccessHandler(function(msg) {
            showMessage(msg, 'success', 'mensagem-doacao-con');
            btn.disabled = false;
            btn.textContent = 'Salvar';
            if (novaDataEntrega) {
                document.getElementById(`doacao-row-${doacaoId}`).style.backgroundColor = '#d4edda';
            } else {
                document.getElementById(`doacao-row-${doacaoId}`).style.backgroundColor = '';
            }
        }).withFailureHandler(function(err){ 
            showMessage('Erro: ' + err.message, 'error', 'mensagem-doacao-con');
        }).atualizarDoacao(dados);
    }
    
    function renderizarPaginacaoDoacoes(currentPage, totalRecords, pageSize) {
        const container = document.getElementById('doacoesPaginationContainer');
        container.innerHTML = '';
        const totalPages = Math.ceil(totalRecords / pageSize);
        if (totalPages <= 1) return;

        const prevButton = document.createElement('button');
        prevButton.textContent = 'Anterior';
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => consultarDoacoes(currentPage - 1);
        
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
        
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Pr√≥xima';
        nextButton.disabled = currentPage === totalPages;
        nextButton.onclick = () => consultarDoacoes(currentPage + 1);

        container.appendChild(prevButton);
        container.appendChild(pageInfo);
        container.appendChild(nextButton);
    }

    // Inside your <script> tag

    // Keep this global to avoid redrawing the chart unnecessarily
    let donationChart = null; 

    function loadDashboard() {
      // Call the function to get the card stats
      google.script.run
        .withSuccessHandler(populateDashboardCards)
        .withFailureHandler(onFailure)
        .getDashboardStats();
        
      // Call the function to get the chart data
      google.script.run
        .withSuccessHandler(createDonationChart)
        .withFailureHandler(onFailure)
        .getDonationSummary();
    }

    function populateDashboardCards(stats) {
      if (stats.error) {
        console.error("Erro ao carregar stats: " + stats.error);
        return;
      }
      
      // Populate all your cards
      document.getElementById('stat-donations').textContent = stats.totalDonations;
      document.getElementById('stat-total-responsaveis').textContent = stats.totalResponsaveis;
      document.getElementById('stat-active-responsaveis').textContent = stats.activeResponsaveis;
      document.getElementById('stat-total-atendidos').textContent = stats.totalAtendidos;
      document.getElementById('stat-active-atendidos').textContent = stats.activeAtendidos;
      document.getElementById('stat-total-voluntarios').textContent = stats.totalVoluntarios;
      document.getElementById('stat-active-voluntarios').textContent = stats.activeVoluntarios;
      
      // Populate new attendance cards
      document.getElementById('stat-attendance').textContent = stats.averageAttendance + '%';
      document.getElementById('stat-avg-manha').textContent = stats.avgManha + '%';
      document.getElementById('stat-avg-tarde').textContent = stats.avgTarde + '%';
      document.getElementById('stat-avg-noite').textContent = stats.avgNoite + '%';

      // Call the new function to build the list
      displayAtendidoAttendance(stats.atendidoAttendanceList);
    }

    /**
     * Creates and displays the list of attendance averages per atendido.
     * @param {Array<{name: string, average: string}>} list
     */
    function displayAtendidoAttendance(list) {
      const container = document.getElementById('atendidoAttendanceListContainer');
      
      // Start building the HTML for the table
      let tableHtml = '<h3>M√©dia de Presen√ßa por Atendido</h3>';
      tableHtml += '<table class="attendance-table">';
      tableHtml += '<thead><tr><th>Nome do Atendido</th><th>M√©dia</th></tr></thead>';
      tableHtml += '<tbody>';

      if (!list || list.length === 0) {
        tableHtml += '<tr><td colspan="2">Nenhum dado de presen√ßa encontrado.</td></tr>';
      } else {
        // Add a row for each atendido
        list.forEach(item => {
          tableHtml += `
            <tr>
              <td>${item.name}</td>
              <td>${item.average}%</td>
            </tr>
          `;
        });
      }

      tableHtml += '</tbody></table>';
      
      // Set the container's HTML all at once
      container.innerHTML = tableHtml;
    }


  </script>
</body>
</html>